<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <title>Web Audio</title>

    <!-- CSS style sheets -->
    <link href="thirdparty/css/pepper-grinder/jquery-ui-1.10.2.custom.css" rel="stylesheet">
    <link href="app.css" rel="stylesheet">

    <!-- Third party libraries -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js" ></script>
    <script type="text/javascript" src="thirdparty/jquery-ui-1.10.2.custom.min.js"></script>

    <!-- Helper libraries -->
    <script type="text/javascript" src="utils.js"></script>

    <!-- Web Audio application -->
    <script type="text/javascript">
    function loadAudioFromUrl( url, loadedCallbackFn, callbackContext ) {
            var request = new XMLHttpRequest();
            request.open("GET", url, true);
            request.responseType = "arraybuffer";

            request.onload = function() {
                consoleout( "Loaded audio '" + url + "'" );
                later( 0, loadedCallbackFn, callbackContext, request.response );
            };

            request.onerror = function() {
                consoleout( "ERROR: Failed to load audio from " + url );
            };

            request.send();
        }

        function stopNode( node, stopSecs ) {
            if( node.stop instanceof Function )
                node.stop( stopSecs );
            if( node.snoteOff instanceof Function )
                node.noteOff( stopSecs );
        }

        function startNode( node, startSecs, loop) {
            //turn on looping
            if( loop )
                node.loop = true;

            //start playback at a predefined time
            if( node.start instanceof Function )
                node.start( startSecs );
            if( node.noteOn instanceof Function )
                node.noteOn( startSecs );

            return node;
        }

        /**
         * Web Audio application
         * @constructor
         */
        function WebAudioApp() {}

        /**
         * Application entry point
         */
        WebAudioApp.prototype.start = function() {
            if(!this.initWebAudio() ) {
                consoleout("Browser does not support web audio!!")
                return;
            }
             this.initMusicControls('#choir', 'assets/looperman-morpheusd-amazing-pt2-choir-120-bpm.wav', '#choirvol');
            this.initMusicControls('#piano', 'assets/looperman-morpheusd-dreamworld-fullpiano-120-bpm.wav', '#pianovol');
        };

        WebAudioApp.prototype.initWebAudio = function() {
            var audioContextClass = window.webkitAudioContext || window.AudioContext;

            if( audioContextClass == null )
                return false;

            this.audioContext = new audioContextClass();
            return true;
        };

        WebAudioApp.prototype.initMusicControls = function( elemId, audioSrc, elemVolId ){
            //init button and disable it by default
            var jqButton = $( elemId ).button({ disabled: true });

            //load audio
            var audioBuffer;
            loadAudioFromUrl( audioSrc, function(audioData){
                //decode the audio data into an audio buffer
                this.audioContext.decodeAudioData(
                                                  audioData,
                                                  function( audioBufferIn ) {
                                                    consoleout( "Decoded audio for '"
                                                               + audioSrc + "'");

                                                    //cache the audio buffer
                                                    audioBuffer = audioBufferIn;

                                                    //enable the button once the audio is ready
                                                    jqButton.button("option", "disabled", false);
                                                  });
            }, this);

            //create the volume control gain node
            var context = this.audioContext,
                volNode;

            if( context.createGain instanceof Function )
                volNode = context.createGain();
            else if( context.createGainNode instanceof Function )
                volNode = context.createGainNode();

            //connect the volume control to the speaker
            volNode.connect( context.destination );

            //create volume control
            $( elemVolId ).slider({
                min: volNode.gain.minValue,
                max: volNode.gain.maxValue,
                step: 0.01,

                value: volNode.gain.value,
                //add cb function when
                //user moves slider
                slide: function( event, ui) {
                    //set the volume directly
                    volNode.gain.value = ui.value;

                    consoleout( "Adjusted music volume: " + ui.value );
                }
            });

            var me = this;
            var activeNode;
            jqButton.click(function( event) {
                //stop the active source node
                if(activeNode != null) {
                    stopNode( activeNode, 0 );
                    activeNode = null;

                    consoleout( "Stopped music loop'" + audioSrc + "'" );
                }

                //start new sound on btn activation
                if($(this).is(':checked')) {
                    //start loop playback
                    activeNode = me.audioContext.createBufferSource();
                    activeNode.buffer = audioBuffer;
                    startNode( activeNode, 0, true );

                    //conect it to volume control
                    activeNode.connect( volNode );

                    consoleout( "Played music loop '" + audioSrc + "'" );
                }
            });
        }
    </script>

    <!-- Application entry -->
    <script type="text/javascript">
        var appInst = new WebAudioApp();

        $(document).ready( function(){
            appInst.start();
        });
    </script>
</head>
<body>
    <div id="appwindow">
        <h2>Playing Audio In a Loop</h2>
        <form>
            <input type="checkbox" id="choir" />
            <label for="choir">Choir Loop</label>
            <span>VOLUME</span>
            <span id="choirvol" style="display: inline-block; width: 300px;"></span><hr/>
            <input type="checkbox" id="piano" />
            <label for="piano">Piano Loop</label>
            <span>VOLUME</span>
            <span id="pianovol" style="display: inline-block; width: 300px;"></span>
        </form>
    </div>
    <div id="outputwindow">
        <h1>Console</h1>
        <div id="output"></div>
    </div>
</body>
</html>